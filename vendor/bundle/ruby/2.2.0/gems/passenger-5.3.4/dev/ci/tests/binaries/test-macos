#!/usr/bin/env bash
# This script is from the "Passenger binaries test" Jenkins job. It runs
# runs tests on the binaries generated by the "build-macos" script.
#
# Required environment variables:
#
#   WORKSPACE
#
# Optional environment variables:
#
#   PASSENGER_ROOT (defaults to $WORKSPACE)
#   OUTPUT_DIR (defaults to $WORKSPACE/output)
#   RUNTIME_DIR (defaults to $WORKSPACE/cache/runtime)

set -e
SELFDIR=$(dirname "$0")
cd "$SELFDIR/../../../../packaging/binaries"
# shellcheck source=../../../../packaging/binaries/shared/lib/library.sh
source "./shared/lib/library.sh"

require_envvar WORKSPACE "$WORKSPACE"

PASSENGER_ROOT="${PASSENGER_ROOT:-$WORKSPACE}"
OUTPUT_DIR="${OUTPUT_DIR:-$WORKSPACE/output}"
RUNTIME_DIR="${RUNTIME_DIR:-$WORKSPACE/cache/runtime}"

RUNTIME_VERSION=$(cat shared/definitions/macos_runtime_version)

run mkdir -p "$OUTPUT_DIR"

run ./macos/package \
	-i "$OUTPUT_DIR" \
	-o "$OUTPUT_DIR"
run ./macos/test \
	-p "$PASSENGER_ROOT" \
	-r "$RUNTIME_DIR/$RUNTIME_VERSION" \
	-i "$OUTPUT_DIR" \
	-I "$OUTPUT_DIR"
